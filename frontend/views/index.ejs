<%# 1. Bloco de Lógica: Define todas as variáveis primeiro %>
<%
    // [CORREÇÃO] Define a URL base onde as imagens estão hospedadas (Servidor Admin).
    // Se estiver rodando localmente, use 'http://localhost:3000'.
    // Em produção (com IPs diferentes), coloque o IP do servidor Admin (ex: 'http://10.0.0.47:3000').
    const ASSETS_BASE_URL = campaign.admServerUrl || 'http://localhost:3000';

    // Função auxiliar para garantir que a URL seja absoluta
    const getAssetUrl = (path) => {
        if (!path) return '';
        if (path.startsWith('http')) return path; // Já é uma URL completa
        return `${ASSETS_BASE_URL}${path}`;
    };

    const template = campaign.template || {};
    const primaryColor = template.primaryColor || '#b403f2'; // [AJUSTE] Cor padrão alinhada com a de cadastro.
    const bodyBgColor = template.backgroundUrl ? 'transparent' : (template.primaryColor || '#f0f2f5');
    const formBgColor = template.formBackgroundColor || '#ffffff';
    const bodyFontColor = template.fontColor || '#333333';
    const bodyFontSize = template.fontSize || '16px';
    const fontFamily = template.fontFamily || "'Inter', sans-serif";
    const bodyBgImage = template.backgroundUrl ? `url(${getAssetUrl(template.backgroundUrl)})` : 'none';
    const logoUrl = getAssetUrl(template.logoUrl);

    // Atualiza a URL do banner promocional, se existir
    if (campaign.preLoginBanner && campaign.preLoginBanner.imageUrl) {
        campaign.preLoginBanner.imageUrl = getAssetUrl(campaign.preLoginBanner.imageUrl);
    }
%>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Rota Hotspot</title>
    <!-- [CRÍTICO] Injeta a URL base da API para os scripts do cliente (register.js, campaign-loader.js) -->
    <script>
        const API_BASE_URL = '<%= campaign.admServerUrl %>';
    </script>
    <!-- Link para a folha de estilos CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <%# 2. Bloco de Estilos: Usa as variáveis definidas acima para gerar o CSS %>
    <style>
        :root {
            --login-bg-color: <%= bodyBgColor %>;
            --login-form-bg-color: <%= formBgColor %>;
            --login-font-color: <%= bodyFontColor %>;
            --login-button-color: <%= primaryColor %>;
            --base-font-size: <%= bodyFontSize %>;
            --font-family: <%= fontFamily %>;
        }
        body {
            background-image: <%= bodyBgImage %>;
            font-family: var(--font-family);
        }
    </style>
</head>
<body>
    <!-- [NOVO] Preloader de Autocarro -->
    <div id="preloader">
        <div class="bus">
            <div class="bus-body">
                <div class="bus-window"></div><div class="bus-window"></div><div class="bus-window"></div>
            </div>
            <div class="bus-wheel back"></div><div class="bus-wheel front"></div>
        </div>
    </div>

    <%# 3. Lógica do Banner Overlay %>
    <% if (!campaign.use_default && campaign.preLoginBanner && campaign.preLoginBanner.imageUrl) { %>
        <div id="banner-overlay">
            <!-- [NOVO] Wrapper para alinhar os controles com a imagem -->
            <div class="banner-content-wrapper">
                <span id="close-banner-btn">&times;</span>
                <a href="<%= campaign.preLoginBanner.targetUrl || '#' %>" target="_blank">
                    <img src="<%= campaign.preLoginBanner.imageUrl %>" alt="Campanha Promocional" style="max-width: 90vw; max-height: 90vh; border-radius: 8px; display: block;">
                </a>
                <div id="banner-countdown"></div>
            </div>
        </div>
    <% } %>

    <div class="form-container" style="visibility: hidden;">
        <div class="form-header" style="text-align: center;">
            <% if (logoUrl) { %>
                <img src="<%= logoUrl %>" alt="Logótipo da Campanha" style="max-width: 150px; margin-bottom: 1rem;">
            <% } %>
            <h1>Bem-vindo A Uma Nova Experiençia!</h1>
            <p>Faça login para acessar à rede.</p>
        </div>

        <!-- Formulário de Login -->
        <form id="loginForm">
            <div class="input-group">
                <label for="email">Seu E-mail</label>
                <input type="email" id="email" name="email" placeholder="seuemail@exemplo.com" required>
            </div>
            <div class="input-group">
                <label for="password">Sua Senha</label>
                <input type="password" id="password" name="password" placeholder="Sua senha" required>
            </div>
            <button type="submit" class="btn">Entrar</button>
        </form>

        <div class="form-footer">
            <p>Ainda não tem uma conta? <a id="registerLink" href="#">Cadastre-se Aqui</a></p>
        </div>
        
        <div id="message" class="message"></div>
    </div>

    <script>
        // [NOVO] Lógica do Preloader
        // O evento 'load' espera que TUDO (imagens, css, etc.) seja carregado.
        window.addEventListener('load', () => {
            const preloader = document.getElementById('preloader');
            const formContainer = document.querySelector('.form-container');

            // Remove o preloader assim que a página carrega completamente
            preloader.style.opacity = '0';
            setTimeout(() => {
                preloader.style.display = 'none';
                formContainer.style.visibility = 'visible';
                // Adiciona uma animação suave de entrada ao formulário
                formContainer.style.animation = 'fadeIn 0.6s ease forwards';
            }, 500); // Tempo da transição de opacidade (sincronizado com o CSS)
        });

        // Passa os dados da campanha renderizados pelo servidor para o JavaScript do lado do cliente
        const bannerData = <%- JSON.stringify(campaign.preLoginBanner || null) %>;

        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('banner-overlay'); // O banner
            const formContainer = document.querySelector('.form-container'); // O formulário

            // A lógica do banner só deve ser executada se o overlay realmente existir na página.
            if (overlay && bannerData && bannerData.imageUrl) {
                const closeBtn = document.getElementById('close-banner-btn'); // O botão 'X'
                const countdownEl = document.getElementById('banner-countdown'); // Onde o contador aparece
                
                formContainer.style.visibility = 'hidden'; // Esconde o formulário para o banner aparecer
                let timeLeft = bannerData.displayTime || 5;
                let countdownInterval;

                const closeBanner = () => {
                    clearInterval(countdownInterval); // Para o contador
                    overlay.style.display = 'none';
                    formContainer.style.visibility = 'visible';
                };

                const updateCountdown = () => {
                    if (timeLeft <= 0) {
                        closeBanner();
                    } else {
                        countdownEl.textContent = `Fechando em ${timeLeft}s...`;
                        timeLeft--;
                    }
                };

                // Inicia o contador
                updateCountdown(); // Chama uma vez para exibir o tempo inicial
                countdownInterval = setInterval(updateCountdown, 1000);

                // Adiciona o evento de clique no botão 'X'
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeBanner);
                }
            }

            /**
             * [NOVO] Função para detetar a cor de fundo do formulário e aplicar uma classe
             * para garantir que a cor do texto tenha um contraste adequado.
             */
            function setContrastColor() {
                if (!formContainer) return;

                // Obtém a cor de fundo computada do formulário
                const bgColor = window.getComputedStyle(formContainer).backgroundColor;

                // Função para calcular a luminância de uma cor RGB
                function getLuminance(color) {
                    const rgb = color.match(/\d+/g);
                    if (!rgb) return 180; // Assume um fundo claro se não conseguir analisar a cor
                    return (0.299 * parseInt(rgb[0]) + 0.587 * parseInt(rgb[1]) + 0.114 * parseInt(rgb[2]));
                }

                const luminance = getLuminance(bgColor);
                formContainer.classList.add(luminance < 149 ? 'theme-dark' : 'theme-light');
            }

            // Executa a função para definir o tema de contraste
            setContrastColor();
        });
    </script>
    <script src="js/login.js"></script> 
</body>
</html>
