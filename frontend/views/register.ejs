<%
    // [CORRIGIDO] Adiciona a mesma lógica de `index.ejs` para garantir que as URLs de assets sejam absolutas.
    const ASSETS_BASE_URL = campaign.admServerUrl || 'http://localhost:3000';

    // Função auxiliar para garantir que a URL seja absoluta
    const getAssetUrl = (path) => {
        if (!path) return '';
        if (path.startsWith('http')) return path; // Já é uma URL completa
        return `${ASSETS_BASE_URL}${path}`;
    };

    const template = campaign.template || {};

    const primaryColor = template.primaryColor || '#b403f2'
    const bodyBgColor = getAssetUrl(template.backgroundUrl) ? 'transparent' : (template.primaryColor || '#7123fe');
    const formBgColor = template.formBackgroundColor || '#ffffff';
    const bodyFontColor = template.fontColor || '#333333';
    const bodyFontSize = template.fontSize || '15px'; // [AJUSTE] Tamanho de fonte equilibrado para leitura e compactação
    const fontFamily = template.fontFamily || "'Inter', sans-serif";
    const bodyBgImage = getAssetUrl(template.backgroundUrl) ? `url(${getAssetUrl(template.backgroundUrl)})` : 'none';
    const logoUrl = getAssetUrl(template.logoUrl);
%>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Rota Hotspot</title>
    <!-- [CRÍTICO] Injeta a URL base da API para os scripts do cliente (register.js, campaign-loader.js) -->
    <script>
        // Esta variável é usada pelos scripts para saber onde o servidor de administração está.
        window.API_BASE_URL = '<%= campaign.admServerUrl %>';
    </script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --login-bg-color: <%= bodyBgColor %>;
            --login-form-bg-color: <%= formBgColor %>;
            --login-font-color: <%= bodyFontColor %>;
            --login-button-color: <%= primaryColor %>;
            --base-font-size: <%= bodyFontSize %>;
            --font-family: <%= fontFamily %>;
        }
        body {
            /* [AJUSTE] Usa um gradiente como fundo padrão, mantendo a imagem do template se existir. */
            <% if (getAssetUrl(template.backgroundUrl)) { %>
                background-image: url(<%= getAssetUrl(template.backgroundUrl) %>);
            <% } else { %>
                background: #7123FE; /* Fallback para navegadores que não suportam gradientes */
                background: radial-gradient(circle, rgba(113, 35, 254, 1) 15%, rgba(180, 3, 242, 1) 100%);
            <% } %>
            font-family: var(--font-family);
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="form-header" style="text-align: center;">
            <% if (logoUrl) { %>
                <img src="<%= logoUrl %>" alt="Logótipo da Campanha" style="max-width: 120px; margin-bottom: 1rem; padding: 5px;">
            <% } %>
            <h1>Crie sua Conta</h1>
            <p>Preencha os dados para se cadastrar.</p>
        </div>

        <!-- Formulário de Cadastro (sem banners, conforme solicitado) -->
        <form id="registerForm">
            <div class="input-group">
                <label for="nomeCompleto">Nome Completo</label>
                <input type="text" id="nomeCompleto" name="nomeCompleto" placeholder="Seu nome completo" required>
            </div>
            <div class="input-group">
                <label for="email">E-mail</label>
                <input type="email" id="email" name="email" placeholder="seuemail@exemplo.com" required>
            </div>
            <div class="input-group">
                <label for="telefone">Telefone</label>
                <input type="tel" id="telefone" name="telefone" placeholder="(00) 90000-0000" required>
            </div>
            <div class="input-group">
                <label for="senha">Senha</label>
                <input type="password" id="senha" name="senha" placeholder="Crie uma senha forte" required>
                <div id="password-feedback" class="password-feedback">
                    <p id="length-check" class="invalid">Pelo menos 6 caracteres</p>
                </div>
            </div>

            <!-- [NOVO] Bloco de consentimento com checkboxes -->
            <div class="form-group consent-group">
                <div class="checkbox-container">
                    <input type="checkbox" id="termsCheckbox" name="terms">
                    <label for="termsCheckbox">
                        Eu li e aceito os <a href="/policy/terms" target="_blank" class="form-link">Termos e Condições</a> do serviço.
                    </label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="marketingCheckbox" name="marketing">
                    <label for="marketingCheckbox">
                        Eu aceito participar de <a href="/policy/promotions" target="_blank" class="form-link">sorteios e promoções</a>.
                    </label>
                </div>
            </div>

            <button type="submit" id="submitButton" class="btn" disabled>Cadastrar</button>
        </form>

        <div class="form-footer">
            <p>Já tem uma conta? <a id="loginLink" href="#">Faça login</a></p>
        </div>
        
        <div id="message" class="message"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const termsCheckbox = document.getElementById('termsCheckbox');
            const passwordInput = document.getElementById('senha');
            const submitButton = document.getElementById('submitButton');

            // Função para verificar todas as condições e atualizar o estado do botão
            function updateButtonState() {
                // Condição 1: Senha tem pelo menos 6 caracteres
                const isPasswordValid = passwordInput.value.length >= 6;
                // Condição 2: Checkbox de termos está marcado
                const areTermsAccepted = termsCheckbox.checked;

                // Habilita o botão SOMENTE se AMBAS as condições forem atendidas
                submitButton.disabled = !(isPasswordValid && areTermsAccepted);
            }

            // Adiciona "escutadores" de eventos para os campos relevantes
            passwordInput.addEventListener('input', updateButtonState);
            termsCheckbox.addEventListener('change', updateButtonState);

            /**
             * [NOVO] Função para detetar a cor de fundo do formulário e aplicar uma classe
             * para garantir que a cor do texto tenha um contraste adequado.
             */
            function setContrastColor() {
                const formContainer = document.querySelector('.form-container');
                if (!formContainer) return;

                // Obtém a cor de fundo computada do formulário
                const bgColor = window.getComputedStyle(formContainer).backgroundColor;

                // Função para calcular a luminância de uma cor RGB
                function getLuminance(color) {
                    // Extrai os valores R, G, B da string 'rgb(r, g, b)'
                    const rgb = color.match(/\d+/g);
                    if (!rgb) return 180; // Assume um fundo claro se não conseguir analisar a cor

                    // Fórmula de luminância percebida
                    return (0.299 * parseInt(rgb[0]) + 0.587 * parseInt(rgb[1]) + 0.114 * parseInt(rgb[2]));
                }

                const luminance = getLuminance(bgColor);

                // Um limiar comum é 149. Abaixo disso, o fundo é considerado "escuro".
                formContainer.classList.add(luminance < 149 ? 'theme-dark' : 'theme-light');
            }

            // Executa a função para definir o tema de contraste
            setContrastColor();
        });
    </script>
    <script src="js/utils.js"></script>
    <script src="js/register.js"></script>
</body>
</html>
